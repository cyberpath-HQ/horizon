# Horizon Development Environment
# This configuration provides PostgreSQL and Redis for local development
# Run with: docker-compose up -d

services:
  # PostgreSQL Database - Primary data store for Horizon CMDB
  postgres:
    image: postgres:18-alpine
    container_name: horizon-postgres
    restart: unless-stopped
    environment:
      # Database configuration - these should be overridden in .env
      POSTGRES_USER: ${HORIZON_DATABASE_USER:-horizon}
      POSTGRES_PASSWORD: ${HORIZON_DATABASE_PASSWORD:-horizon_secret_password_change_in_production}
      POSTGRES_DB: ${HORIZON_DATABASE_NAME:-horizon}

    volumes:
      # Persist database data across container restarts
      - postgres_data:/var/lib/postgresql/data
      # Mount initialization scripts if needed
      - ./docker/init-scripts:/docker-entrypoint-initdb.d:ro

    ports:
      # Expose PostgreSQL on configured port (default 5432)
      - "${HORIZON_DATABASE_PORT:-5432}:5432"

    networks:
      - horizon-internal

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${HORIZON_DATABASE_USER:-horizon}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Resource limits for development environment
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

    # PostgreSQL performance tuning for development
    command: >
      -c shared_buffers=128MB
      -c max_connections=100
      -c work_mem=4MB
      -c maintenance_work_mem=64MB
      -c effective_cache_size=256MB
      -c random_page_cost=1.1

  # Redis - Caching and session management
  redis:
    image: redis:8-alpine
    container_name: horizon-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

    volumes:
      # Persist Redis data across container restarts
      - redis_data:/data

    ports:
      # Expose Redis on configured port (default 6379)
      - "${REDIS_PORT:-6379}:6379"

    networks:
      - horizon-internal

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Resource limits for development environment
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

# Named volumes for data persistence
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${PWD}/.docker/volumes/postgres"

  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${PWD}/.docker/volumes/redis"

# Internal network for service communication
networks:
  horizon-internal:
    driver: bridge
    name: horizon-internal
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
